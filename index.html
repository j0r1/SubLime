<!doctype html>
<html>
    <head>
        <script id="mybookmarklet">

            function mainInitialized()
            {
                console.log("Loaded main");
                
                window.initializedBookmarklet = true;
                window.initializingBookmarklet = false;
                setTimeout(function() { myBookmarkLet(); }, 0);
            }

            function initBookmarklet()
            {
                var s = document.createElement("script");
                
                s.src = "https://pyservsite.appspot.com/maincode.js";
                s.onload = mainInitialized;

                document.body.appendChild(s);
            }

            function myBookmarkLet()
            {
                if (window.initializingBookmarklet)
                    return;

                if (!window.initializedBookmarklet)
                {
                    window.initializingBookmarklet = true;
                    initBookmarklet();
                    return;
                }

                maincode.run();
            }
        </script>
        <script>
            function run()
            {
                var elem = document.getElementById("mybookmarklet");
                var data = elem.innerHTML;

                data = "void((function() { " + data + "\nmyBookmarkLet(); })())";

                //console.log(data);
                
                elem = document.getElementById("mylink");
                elem.setAttribute("href", "javascript:" + encodeURIComponent(data));

                elem = document.getElementById("mylink2");
                elem.setAttribute("href", "javascript:" + encodeURIComponent(data.replace("https://pyservsite.appspot.com","http://localhost:8080")));
            }
        </script>
    </head>
    <body onload="run()">
        <a href="javascript:void(0)" id="mylink">Bookmarklet</a>
        <a href="javascript:void(0)" id="mylink2">Bookmarklet localhost</a> 
        <img src="loading.png">
    </body>
</html>
